---
original_url: https://xquartz.macosforge.org/trac/ticket/512
created_at: 2011-10-18 20:31:38 -0700
updated_at: 2015-09-01 21:50:42 -0700
closed_at: 2012-04-24 00:34:17 -0700
status: closed
type: crash
resolution: Fixed
reporter: cdavis@…
owner: jeremyhu@…
priority: Expected
milestone: 2.7.2
component: GLX
version: dev (master)
---

Random OpenGL crashes in Wine with Xquartz 2.7.0 beta 2
=======================================================


I don't know why, but occasionally, Wine will randomly crash trying to create an OpenGL context. This started happening when I upgraded to Xquartz 2.7.0 beta 2, so I'm assuming that this is an Xquartz bug.

When Wine dies, the backtrace looks a bit like this:

    Backtrace:
    =>0 0x90a432e7 mm+0x3a7() in liblapack.dylib (0x0033f5a8)
      1 0x90a4cd5b in liblapack.dylib (+0x440d5a) (0x0033f878)
      2 0x90a4381f first+0xd6() in liblapack.dylib (0x0033f8a8)
      3 0x40584fe2 in libGL.1.dylib (+0x2fe1) (0x0033f9c8)
      4 0x40582e85 in libGL.1.dylib (+0xe84) (0x0033f9f8)
      5 0x4058b823 in libGL.1.dylib (+0x9822) (0x0033fa48)
      6 0x40587243 in libGL.1.dylib (+0x5242) (0x0033fa78)
      7 0x405871ce in libGL.1.dylib (+0x51cd) (0x0033fac8)
    [Wine code below...]

I'll say up from that I cannot reliably reproduce this. But I can reproduce this and have several times. All the crashes I have seen take this form (except for one, but that's another bug, in Xinerama), with the same five locations within the libGL dylib showing up in the backtrace.



---

*cdavis@…* commented *[on Oct 18, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:1 "October 18, 2011 at 8:33 PM PDT")*

Oops, I forgot to format the backtrace.

    Backtrace:
     =>0 0x90a432e7 mm+0x3a7() in liblapack.dylib (0x0033f5a8)
       1 0x90a4cd5b in liblapack.dylib (+0x440d5a) (0x0033f878)
       2 0x90a4381f first+0xd6() in liblapack.dylib (0x0033f8a8)
       3 0x40584fe2 in libGL.1.dylib (+0x2fe1) (0x0033f9c8)
       4 0x40582e85 in libGL.1.dylib (+0xe84) (0x0033f9f8)
       5 0x4058b823 in libGL.1.dylib (+0x9822) (0x0033fa48)
       6 0x40587243 in libGL.1.dylib (+0x5242) (0x0033fa78)
       7 0x405871ce in libGL.1.dylib (+0x51cd) (0x0033fac8)

There, that's better.



---

*cdavis@…* commented *[on Oct 18, 2011](https://xquartz.macosforge.org/trac/attachment/ticket/512/ChipsComputer.spx "October 18, 2011 at 9:09 PM PDT")*

-   **Attachment** *[ChipsComputer.spx](../attachment/ticket/512/ChipsComputer.spx)* (152.3 KB) added

System Report for my computer



---

*jeremyhu@…* commented *[on Oct 18, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:2 "October 18, 2011 at 9:16 PM PDT")*

I dunno how you got that backtrace, but it's not useful. Please attach the crash report.



---

*jeremyhu@…* commented *[on Oct 18, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:3 "October 18, 2011 at 9:17 PM PDT")*

Also, open a ticket for your xinerama issue. I can't think of any known xinerama bugs in XQuartz.



---

*cdavis@…* commented *[on Oct 18, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:4 "October 18, 2011 at 9:21 PM PDT")*

Replying to [jeremyhu@…](https://xquartz.macosforge.org/trac/ticket/512#comment:2):

> I dunno how you got that backtrace,

I got it from Wine. This is the backtrace it produced when it crashed.

> but it's not useful.

I know, but this is all I have.

> > Please attach the crash report.

Can't. Wine hooks SIGSEGV and SIGBUS, so no crash report is produced.



---

*cdavis@…* commented *[on Oct 18, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:5 "October 18, 2011 at 9:25 PM PDT")*

Replying to [cdavis@…](https://xquartz.macosforge.org/trac/ticket/512#comment:4):

> Replying to [jeremyhu@…](https://xquartz.macosforge.org/trac/ticket/512#comment:2):
>
> > I dunno how you got that backtrace,
>
> I got it from Wine. This is the backtrace it produced when it crashed.
>
> > but it's not useful.
>
> I know, but this is all I have.
>
> > > Please attach the crash report.
>
> Can't. Wine hooks SIGSEGV and SIGBUS, so no crash report is produced.

Also, if you haven't figured it out already, this is a client-side crash, not a server-side one.



---

*jeremyhu@…* commented *[on Oct 19, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:6 "October 19, 2011 at 11:59 AM PDT")*

I understand that. You need to give me a crash report for wine's crash.

Yes, I understand it traps SIGSEGV, but that's the beauty of OSS. You can just comment out that line and presto, Apple's Crash Reporter will pick up the crash ;)



---

*cdavis@…* commented *[on Oct 19, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:7 "October 19, 2011 at 3:31 PM PDT")*

Replying to [jeremyhu@…](https://xquartz.macosforge.org/trac/ticket/512#comment:6):

> I understand that. You need to give me a crash report for wine's crash.
>
> Yes, I understand it traps SIGSEGV, but that's the beauty of OSS. You can just comment out that line and presto, Apple's Crash Reporter will pick up the crash ;)

Right. Here ya go. This crash is from running the opengl32:opengl test (do a:

    $ cd <wine-src>/dlls/opengl32/tests
    $ make opengl.ok

to reproduce).

The interesting thing is that, whether it crashed or not, Wine printed this:

    err:wgl:X11DRV_wglCreateContext Cannot get FB Config for iPixelFormat 0, expect problems!
    err:wgl:X11DRV_wglCreateContext Cannot get FB Config for iPixelFormat 0, expect problems!

and when it *didn't* crash, it printed this in addition:

    err:wgl:internal_SetPixelFormat Invalid operation on root_window
    err:wgl:X11DRV_wglShareLists Could not share display lists, one of the contexts has been current already !
    err:wgl:X11DRV_wglShareLists Could not share display lists because hglrc2 has already shared lists before

though I don't know if those last two lines are part of the problem or not.

And then, I tried to run the opengl32:opengl test over ssh, and this is what Wine printed for that:

    Wed Oct 19 16:06:28 chips-computer-3.local wine[28908] <Error>: kCGErrorIllegalArgument: _CGSFindSharedWindow: WID 12383
    Wed Oct 19 16:06:28 chips-computer-3.local wine[28908] <Error>: kCGErrorFailure: Set a breakpoint @ CGErrorBreakpoint() to catch errors as they are logged.
    Wed Oct 19 16:06:28 chips-computer-3.local wine[28908] <Error>: kCGErrorIllegalArgument: CGSSetWindowSendExposed: Invalid window 0x305f
    Wed Oct 19 16:06:28 chips-computer-3.local wine[28908] <Error>: unknown error code: invalid drawable
    error: xp_attach_gl_context returned: 2
    X Error of failed request:  0
      Major opcode of failed request:  149 (GLX)
      Minor opcode of failed request:  26 (X_GLXMakeContextCurrent)
      Serial number of failed request:  212
      Current serial number in output stream:  212

but, oddly enough, it didn't fail to find a pixel format.



---

*cdavis@…* commented *[on Oct 19, 2011](https://xquartz.macosforge.org/trac/attachment/ticket/512/wine_2011-10-19-160810_chips-computer-3.crash "October 19, 2011 at 3:33 PM PDT")*

-   **Attachment** *[wine\_2011-10-19-160810\_chips-computer-3.crash](../attachment/ticket/512/wine_2011-10-19-160810_chips-computer-3.crash)* (28.1 KB) added

Crash report from opengl32:opengl test



---

*jeremyhu@…* commented *[on Oct 19, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:8 "October 19, 2011 at 4:34 PM PDT")*

-   **Status** changed from *new* to *assigned*
-   **Milestone** set to *2.7.0*

Thanks. That is a very interesting place to crash at... hmm...

Can you run with these environment variables set:

    LIBGL_DEBUG=1 LIBGL_DIAGNOSTIC=1 LIBGL_DUMP_VISUALID=1

That will cause extra debug spew to print out. Also, you might want to try the software renderer to see if that makes a difference with:

    LIBGL_ALWAYS_SOFTWARE=1 LIBGL_ALLOW_SOFTWARE=1


---

*cdavis@…* commented *[on Oct 19, 2011](https://xquartz.macosforge.org/trac/attachment/ticket/512/opengl.crash.log "October 19, 2011 at 8:34 PM PDT")*

-   **Attachment** *[opengl.crash.log](../attachment/ticket/512/opengl.crash.log)* (127.0 KB) added

Debug/diag output from libGL (crash)



---

*cdavis@…* commented *[on Oct 19, 2011](https://xquartz.macosforge.org/trac/attachment/ticket/512/opengl.nocrash.log "October 19, 2011 at 8:34 PM PDT")*

-   **Attachment** *[opengl.nocrash.log](../attachment/ticket/512/opengl.nocrash.log)* (135.2 KB) added

Debug/diag output from libGL (no crash)



---

*cdavis@…* commented *[on Oct 19, 2011](https://xquartz.macosforge.org/trac/attachment/ticket/512/opengl.soft.log "October 19, 2011 at 8:35 PM PDT")*

-   **Attachment** *[opengl.soft.log](../attachment/ticket/512/opengl.soft.log)* (136.3 KB) added

Debug/diag output from libGL (software, no crash)



---

*cdavis@…* commented *[on Oct 19, 2011](https://xquartz.macosforge.org/trac/attachment/ticket/512/opengl.softcrash.log "October 19, 2011 at 8:35 PM PDT")*

-   **Attachment** *[opengl.softcrash.log](../attachment/ticket/512/opengl.softcrash.log)* (127.1 KB) added

Debug/diag output from libGL (software, crash)



---

*cdavis@…* commented *[on Oct 19, 2011](https://xquartz.macosforge.org/trac/attachment/ticket/512/opengl.rem.log "October 19, 2011 at 8:35 PM PDT")*

-   **Attachment** *[opengl.rem.log](../attachment/ticket/512/opengl.rem.log)* (97.2 KB) added

Debug/diag output from libGL (remote)



---

*cdavis@…* commented *[on Oct 19, 2011](https://xquartz.macosforge.org/trac/attachment/ticket/512/opengl.remsoft.log "October 19, 2011 at 8:36 PM PDT")*

-   **Attachment** *[opengl.remsoft.log](../attachment/ticket/512/opengl.remsoft.log)* (97.3 KB) added

Debug/diag output from libGL (remote, software)



---

*cdavis@…* commented *[on Oct 19, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:9 "October 19, 2011 at 8:37 PM PDT")*

Replying to [jeremyhu@…](https://xquartz.macosforge.org/trac/ticket/512#comment:8):

> Thanks. That is a very interesting place to crash at... hmm...
>
> Can you run with these environment variables set:
>
>     LIBGL_DEBUG=1 LIBGL_DIAGNOSTIC=1 LIBGL_DUMP_VISUALID=1

Done. Files are attached.

> That will cause extra debug spew to print out. Also, you might want to try the software renderer to see if that makes a difference with:
>
>     LIBGL_ALWAYS_SOFTWARE=1 LIBGL_ALLOW_SOFTWARE=1

It doesn't.



---

*jeremyhu@…* commented *[on Oct 20, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:10 "October 20, 2011 at 10:06 AM PDT")*

-   **Description** modified

I want to reproduce this on my system. Can you please tell me how you are building wine and running that test, so can do it myself? Assume I have a fresh checkout from git (git clone <git://source.winehq.org/git/wine.git>) and just list a series of commands to copy/paste which get to the commit you are seeing the problems with, configure, build, and test.

Thanks.



---

*cdavis@…* commented *[on Oct 21, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:11 "October 21, 2011 at 9:02 AM PDT")*

Replying to [jeremyhu@…](https://xquartz.macosforge.org/trac/ticket/512#comment:10):

> I want to reproduce this on my system. Can you please tell me how you are building wine and running that test, so can do it myself? Assume I have a fresh checkout from git (git clone <git://source.winehq.org/git/wine.git>) and just list a series of commands to copy/paste which get to the commit you are seeing the problems with, configure, build, and test.
>
> Thanks.

All right. From the Wine source directory, do this:

    $ ./configure --x-includes=/opt/X11/include --x-libraries=/opt/X11/lib
    $ make
    $ cd dlls/opengl32/tests
    $ make opengl.ok

If you're trying to make the test crash, you can do this (after `cd`'ing to `dlls/opengl32/tests`, assuming you're running `bash`):

    $ while make opengl.ok; do rm opengl.ok; done

The `make` fails when the test crashes.



---

*jeremyhu@…* commented *[on Oct 24, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:12 "October 24, 2011 at 4:38 PM PDT")*

Since this is in MakeContextCurrent, I'm hoping that this is fixed with the changes I made for [\#⁠514](https://xquartz.macosforge.org/trac/ticket/514) (5c44c1348ea13f51a1616968daa7034bb48e42b1).

I am building wine now and will run your tests for a while to see if I can reproduce it now with those changes.



---

*jeremyhu@…* commented *[on Oct 24, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:13 "October 24, 2011 at 5:55 PM PDT")*

I can't seem to figure out how to get these tests to run. First off, the above instructions seem to be incomplete. I need to set DYLD\_FALLBACK\_LIBRARY\_PATH so it can dlopen() libX11:

    DYLD_FALLBACK_LIBRARY_PATH=/opt/X11/lib:/usr/lib make opengl.ok

but then it just fails like:

    ../../../tools/runtest -q -P wine -M opengl32.dll -T ../../.. -p opengl32_test.exe.so opengl.c && touch opengl.ok
    err:seh:raise_exception Unhandled exception code c0000005 flags 0 addr 0x7bc6255e
    err:seh:raise_exception Unhandled exception code c0000005 flags 0 addr 0x7bc6255e
    err:seh:raise_exception Unhandled exception code c0000005 flags 0 addr 0x7bc6255e
    make: *** [opengl.ok] Error 5

If you can get me past this, I'll give it a try. If not, you'll just need to see if rc1 works for you.



---

*jeremyhu@…* commented *[on Oct 24, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:14 "October 24, 2011 at 5:56 PM PDT")*

It's possible something in wine itself is borked, so if you can tell me what your HEAD is, I'll try that.

My head is 5e0050d0010a3007d70b6f2245832337fc82cb05



---

*cdavis@…* commented *[on Oct 24, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:15 "October 24, 2011 at 9:38 PM PDT")*

Replying to [jeremyhu@…](https://xquartz.macosforge.org/trac/ticket/512#comment:13):

> I can't seem to figure out how to get these tests to run. First off, the above instructions seem to be incomplete. I need to set DYLD\_FALLBACK\_LIBRARY\_PATH so it can dlopen() libX11:
>
>     DYLD_FALLBACK_LIBRARY_PATH=/opt/X11/lib:/usr/lib make opengl.ok

Oh yeah. I forgot about that, because I do that in my bashrc.

> but then it just fails like:
>
>     ../../../tools/runtest -q -P wine -M opengl32.dll -T ../../.. -p opengl32_test.exe.so opengl.c && touch opengl.ok
>     err:seh:raise_exception Unhandled exception code c0000005 flags 0 addr 0x7bc6255e
>     err:seh:raise_exception Unhandled exception code c0000005 flags 0 addr 0x7bc6255e
>     err:seh:raise_exception Unhandled exception code c0000005 flags 0 addr 0x7bc6255e
>     make: *** [opengl.ok] Error 5
>
> If you can get me past this, I'll give it a try. If not, you'll just need to see if rc1 works for you.

If you want Apple's Crash Reporter to pick up the crash, do the following. In `dlls/ntdll/signal_i386.c`, find these lines:

        if (sigaction( SIGSEGV, &sig_act, NULL ) == -1) goto error;
        if (sigaction( SIGBUS, &sig_act, NULL ) == -1) goto error;

and comment them out. (They are lines 2245 and 2248, respectively). That should stop Wine from trapping segfaults.



---

*cdavis@…* commented *[on Oct 24, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:16 "October 24, 2011 at 9:39 PM PDT")*

Replying to [jeremyhu@…](https://xquartz.macosforge.org/trac/ticket/512#comment:14):

> It's possible something in wine itself is borked, so if you can tell me what your HEAD is, I'll try that.
>
> My head is 5e0050d0010a3007d70b6f2245832337fc82cb05

So's mine, and I am able to reproduce it there.



---

*jeremyhu@…* commented *[on Oct 24, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:17 "October 24, 2011 at 10:33 PM PDT")*

Those weren't segfaults that I was experiencing ... wine never prints a backtrace or anything. It just prints those unhandled exceptions.

In any event, please test 2.7.0\_rc1 ... if the issue persists, is there anything else in your .bashrc that might be related to my not being able to run the tests?

Thanks.



---

*cdavis@…* commented *[on Oct 24, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:18 "October 24, 2011 at 11:12 PM PDT")*

Replying to [jeremyhu@…](https://xquartz.macosforge.org/trac/ticket/512#comment:17):

> Those weren't segfaults that I was experiencing ... wine never prints a backtrace or anything. It just prints those unhandled exceptions.

Actually, those are segfaults. That's Wine's way of reporting them. 0xC0000005 is the NTSTATUS code for STATUS\_ACCESS\_VIOLATION--the Windows version of a segfault. If you did what I told you, Wine wouldn't pick up the segfaults up and turn them into Windows-style AVs. (I would like to remind you that it was your idea in the first place to comment out those lines!)

> In any event, please test 2.7.0\_rc1 ... if the issue persists, is there anything else in your .bashrc that might be related to my not being able to run the tests?

Still present.

Oh, and I just remembered: you have to build Wine with regular GCC 4.2. You can't use any of the LLVM compilers. I'm still working on that. (I thought that was common knowledge. Apparently not...)



---

*jeremyhu@…* commented *[on Oct 24, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:19 "October 24, 2011 at 11:32 PM PDT")*

Replying to [cdavis@…](https://xquartz.macosforge.org/trac/ticket/512#comment:18):

> Actually, those are segfaults. That's Wine's way of reporting them. 0xC0000005 is the NTSTATUS code for STATUS\_ACCESS\_VIOLATION--the Windows version of a segfault. If you did what I told you, Wine wouldn't pick up the segfaults up and turn them into Windows-style AVs. (I would like to remind you that it was your idea in the first place to comment out those lines!)

Ah, I didn't realize that. Per your original comment, I thought wine printed a backtrace in its handler, so I just assumed that was a different error. I'm rebuilding now and will take a look tomorrow.

> Oh, and I just remembered: you have to build Wine with regular GCC 4.2. You can't use any of the LLVM compilers. I'm still working on that. (I thought that was common knowledge. Apparently not...)

Oh yeah, I did know that, but I had forgotten. I'm building it with gcc now instead of llvm-gcc.

Did you try 2.7.0\_rc1?



---

*cdavis@…* commented *[on Oct 25, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:20 "October 25, 2011 at 8:53 AM PDT")*

Replying to [jeremyhu@…](https://xquartz.macosforge.org/trac/ticket/512#comment:19):

> Did you try 2.7.0\_rc1?

Yep. Still present.



---

*jeremyhu@…* commented *[on Oct 25, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:21 "October 25, 2011 at 10:41 AM PDT")*

Ok, then you need to help me figure out how to reproduce this. When I run the test suite, I just see this over and over, never a crash:

    ../../../tools/runtest -q -P wine -M opengl32.dll -T ../../.. -p opengl32_test.exe.so opengl.c && touch opengl.ok
    fixme:iphlpapi:NotifyAddrChange (Handle 0xf7f54c, overlapped 0xf7f530): stub
    err:wgl:X11DRV_wglCreateContext Cannot get FB Config for iPixelFormat 0, expect problems!
    err:wgl:X11DRV_wglCreateContext Cannot get FB Config for iPixelFormat 0, expect problems!
    err:wgl:internal_SetPixelFormat Invalid operation on root_window
    err:wgl:X11DRV_wglShareLists Could not share display lists, one of the contexts has been current already !
    err:wgl:X11DRV_wglShareLists Could not share display lists because hglrc2 has already shared lists before
    opengl.c:431: Tests skipped: No suitable pixel formats found
    opengl.c:1365: Tests skipped: WGL_ARB_pbuffer not supported, skipping pbuffer test

I built wine like this:

    export CC=/opt/local/bin/gcc-apple-4.2
    export DYLD_FALLBACK_LIBRARY_PATH=/opt/X11/lib:/usr/lib
    export PATH=/opt/X11/bin:$PATH
    export PKG_CONFIG_PATH=/opt/X11/share/pkgconfig:/opt/X11/lib/pkgconfig

    ./configure --x-include=/opt/X11/include --x-lib=/opt/X11/lib
    make -j3

with this local change:

    diff --git a/dlls/ntdll/signal_i386.c b/dlls/ntdll/signal_i386.c
    index e839994..fc7b635 100644
    --- a/dlls/ntdll/signal_i386.c
    +++ b/dlls/ntdll/signal_i386.c
    @@ -2242,8 +2242,10 @@ void signal_init_process(void)
         if (sigaction( SIGUSR1, &sig_act, NULL ) == -1) goto error;
     
         sig_act.sa_sigaction = segv_handler;
    +#if 0
         if (sigaction( SIGSEGV, &sig_act, NULL ) == -1) goto error;
         if (sigaction( SIGILL, &sig_act, NULL ) == -1) goto error;
    +#endif
     #ifdef SIGBUS
         if (sigaction( SIGBUS, &sig_act, NULL ) == -1) goto error;
     #endif

And test it like this:

    cd dlls/opengl32/tests
    while make opengl.ok ; do rm opengl.ok; done

gcc-apple-4.2 was built from MacPorts and corresponds to (pre llvm) gcc-4.2 from older versions of XCode.

Can you please provide an updated crash report using 2.7.0\_rc1 and using libraries from /opt/X11/lib and NOT /Users/chip/Gentoo/usr/lib



---

*jeremyhu@…* commented *[on Oct 25, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:22 "October 25, 2011 at 10:43 AM PDT")*

Also, what version introduced this. I know you said that you saw it first when you updated to 2.7.0\_beta2, but what did you have before that? Was it working on beta1?



---

*jeremyhu@…* commented *[on Oct 25, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:23 "October 25, 2011 at 10:43 AM PDT")*

-   **Keywords** *regression* added



---

*jeremyhu@…* commented *[on Oct 25, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:24 "October 25, 2011 at 12:30 PM PDT")*

Ok, I'm able to reproduce it, but it happens rarely under normal circumstances.

It does crash under guard malloc, so that should help.



---

*cdavis@…* commented *[on Oct 25, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:25 "October 25, 2011 at 12:33 PM PDT")*

Replying to [jeremyhu@…](https://xquartz.macosforge.org/trac/ticket/512#comment:22):

> Also, what version introduced this. I know you said that you saw it first when you updated to 2.7.0\_beta2, but what did you have before that?

2.6.3, I believe.

> Was it working on beta1?

Don't know. I'll find out tonight.



---

*jeremyhu@…* commented *[on Oct 25, 2011](https://xquartz.macosforge.org/trac/ticket/512#comment:26 "October 25, 2011 at 1:19 PM PDT")*

-   **Keywords** *regression* removed
-   **Milestone** changed from *2.7.0* to *2.7.1*

Ok, so under gmalloc, the wine opengl test segfaults when using mesa 7.8, 7.10, and 7.11 ...

I really need a reduced test case (preferably without wine) to work on this further.

Since this isn't a regression, I'm adjusting for 2.7.1, but if a good test case surfaces in the next week or so, I may be able to get this into 2.7.0.



---

*cdavis@…* commented *[on Jan 16, 2012](https://xquartz.macosforge.org/trac/ticket/512#comment:27 "January 16, 2012 at 10:37 PM PST")*

Replying to [jeremyhu@…](https://xquartz.macosforge.org/trac/ticket/512#comment:26):

> Ok, so under gmalloc, the wine opengl test segfaults when using mesa 7.8, 7.10, and 7.11 ...
>
> I really need a reduced test case (preferably without wine) to work on this further.

Fair enough. (Sorry it took so long. I've been very busy.)



---

*cdavis@…* commented *[on Jan 16, 2012](https://xquartz.macosforge.org/trac/ticket/512#comment:28 "January 16, 2012 at 10:41 PM PST")*

This testcase approximately reproduces Wine's behavior from the opengl32 test. (To that effect, I copied some of Wine's code; hope that's OK.)

One major difference is that, when ChoosePixelFormat() fails under Wine, it defaults to PF <a href="https://xquartz.macosforge.org/trac/ticket/512" class="missing ticket">#⁠0</a>; the testcase returns a NULL FBConfig, and promptly aborts. Of course, Wine expects PF <a href="https://xquartz.macosforge.org/trac/ticket/512" class="missing ticket">#⁠0</a> to always work, which should account for the random crashes.

If this isn't adequate, please let me know.



---

*jeremyhu@…* commented *[on Jan 28, 2012](https://xquartz.macosforge.org/trac/ticket/512#comment:29 "January 28, 2012 at 2:23 AM PST")*

-   **Milestone** changed from *2.7.1* to *2.7.2*



---

*cdavis@…* commented *[on Feb 11, 2012](https://xquartz.macosforge.org/trac/attachment/ticket/512/glxtest.c "February 11, 2012 at 4:09 PM PST")*

-   **Attachment** *[glxtest.c](../attachment/ticket/512/glxtest.c)* (20.9 KB) added

Testcase approximately reproducing Wine's behavior



---

*cdavis@…* commented *[on Feb 11, 2012](https://xquartz.macosforge.org/trac/ticket/512#comment:30 "February 11, 2012 at 4:18 PM PST")*

Replying to [cdavis@…](https://xquartz.macosforge.org/trac/ticket/512#comment:28):

> This testcase approximately reproduces Wine's behavior from the opengl32 test. (To that effect, I copied some of Wine's code; hope that's OK.)
>
> One major difference is that, when ChoosePixelFormat() fails under Wine, it defaults to PF <a href="https://xquartz.macosforge.org/trac/ticket/512" class="missing ticket">#⁠0</a>; the testcase returns a NULL FBConfig, and promptly aborts. Of course, Wine expects PF <a href="https://xquartz.macosforge.org/trac/ticket/512" class="missing ticket">#⁠0</a> to always work, which should account for the random crashes.
>
> If this isn't adequate, please let me know.

I've attached a new version that more accurately reproduces Wine's behavior.

Like Wine itself, this test case crashes randomly, but it crashes in a different way. When libGL calls malloc(3), the heap detects that it has been corrupted somehow, and calls abort(3). I wonder if this is what's happening in Wine--if OpenGL is crashing trying to get the retain count of a CGLPixelFormatObj because the heap is corrupted.



---

*jeremyhu@…* commented *[on Feb 11, 2012](https://xquartz.macosforge.org/trac/ticket/512#comment:31 "February 11, 2012 at 5:39 PM PST")*

Maybe, but I won't be able to get to this for a while. Can you try running it under guardmalloc and with MallocStackLogging enabled. See the [guardmalloc man page](https://developer.apple.com/library/mac/#documentation/Darwin/Reference/ManPages/man3/guardmalloc.3.html).



---

*cdavis@…* commented *[on Feb 11, 2012](https://xquartz.macosforge.org/trac/ticket/512#comment:32 "February 11, 2012 at 8:01 PM PST")*

Yep, it's heap corruption, alright. With Guard malloc turned on, the program crashes reliably every time. In fact, there are at least two places in libGL where I found it crashed:

-   `glXMakeCurrent()`. This one appears to have crashed in libXplugin. Backtrace:

        #⁠0  0x000000010004b543 in _glapi_create_table_from_handle ()
        #⁠1  0x000000010001ca75 in _apple_glapi_create_table ()
        #⁠2  0x000000010001cb67 in apple_glapi_oglfw_viewport_scissor ()
        #⁠3  0x000000010001c646 in surface_make_current ()
        #⁠4  0x000000010001b083 in apple_glx_make_current_context ()
        #⁠5  0x0000000100023517 in applegl_bind_context ()
        #⁠6  0x00000001000206d3 in MakeContextCurrent ()
        #⁠7  0x00000001000018a7 in main () at glxtest.c:562

-   `glXCreateContext()`. This is after I changed it to call that instead of glXCreateNewContext(). Backtrace:

        #⁠0  0x000000010001ecb4 in glXCreateContext ()
        #⁠1  0x00000001000021ba in create_glxcontext (display=0x10116adb0, fmt=0x112d28c40, vis=0x1135b0d80, shareList=0x0) at glxtest.c:468
        #⁠2  0x00000001000017f8 in main () at glxtest.c:553

There might be even more.

I will attach the logs I produced with malloc\_history, as well as the updated glxtest.c source.



---

*cdavis@…* commented *[on Feb 11, 2012](https://xquartz.macosforge.org/trac/attachment/ticket/512/glxtest.2.c "February 11, 2012 at 8:02 PM PST")*

-   **Attachment** *[glxtest.2.c](../attachment/ticket/512/glxtest.2.c)* (21.4 KB) added

Updated testcase that crashes in glXCreateContext()



---

*cdavis@…* commented *[on Feb 11, 2012](https://xquartz.macosforge.org/trac/attachment/ticket/512/glxtest.log "February 11, 2012 at 8:04 PM PST")*

-   **Attachment** *[glxtest.log](../attachment/ticket/512/glxtest.log)* (1.1 MB) added

malloc\_history(1) log from glXCreateContext() crash



---

*cdavis@…* commented *[on Feb 11, 2012](https://xquartz.macosforge.org/trac/attachment/ticket/512/glxtest-2.log "February 11, 2012 at 8:05 PM PST")*

-   **Attachment** *[glxtest-2.log](../attachment/ticket/512/glxtest-2.log)* (1.2 MB) added

malloc\_history(1) log from glXMakeCurrent() crash



---

*jonas.maebe@…* commented *[on Apr 22, 2012](https://xquartz.macosforge.org/trac/ticket/512#comment:33 "April 22, 2012 at 5:26 AM PDT")*

Both glxtest.c and glxtest.2.c contain a bug that is not in the original wine code as far as I can tell: the tests free the "vis" result of glXGetVisualFromFBConfig() and afterwards still pass it to glXCreateContext(). That's what is causing their crashes.



---

*jonas.maebe@…* commented *[on Apr 22, 2012](https://xquartz.macosforge.org/trac/ticket/512#comment:34 "April 22, 2012 at 6:25 AM PDT")*

The bugs are in mesa. Here's a patch to fix the first crash (not having started this report, I can't attach anything):

    commit 1a5dca1c65117053f878e2e8f582032ee5a38720
    Author: Jonas Maebe <jonas.maebe@elis.ugent.be>
    Date:   Sun Apr 22 15:06:32 2012 +0200

        glapi: Correct size of allocated _glapi_table struct
        
        The __glapi_gentable_set_remaining_noop() routine treats the _glapi_struct
        as an array of _glapi_get_dispatch_table_size() pointers, so we have to
        allocate _glapi_get_dispatch_table_size()*sizeof(void*) bytes rather than
        sizeof(struct _glapi_struct) bytes.

    diff --git a/src/mapi/glapi/glapi_gentable.c b/src/mapi/glapi/glapi_gentable.c
    index 5c04801..f86ed56 100644
    --- a/src/mapi/glapi/glapi_gentable.c
    +++ b/src/mapi/glapi/glapi_gentable.c
    @@ -105,7 +105,7 @@ __glapi_gentable_set_remaining_noop(struct _glapi_table *disp) {
     
     struct _glapi_table *
     _glapi_create_table_from_handle(void *handle, const char *symbol_prefix) {
    -    struct _glapi_table *disp = calloc(1, sizeof(struct _glapi_table));
    +    struct _glapi_table *disp = calloc(_glapi_get_dispatch_table_size(), sizeof(void*));
         char symboln[512];
     
         if(!disp)

GuardMalloc also revealed a second crash, fixed by this patch. I'm however not 100% certain about this patch, because I don't know the underlying logic and the comments seem to indirectly suggest that the current order (destroy/unlock rather than unlock/destroy) may be on purpose. In any case, the current order is definitely not safe under all circumstances, as demonstrated by GuardMalloc.

    commit 0efef56e6a72882cf5290b9d996a64023286f440
    Author: Jonas Maebe <jonas.maebe@elis.ugent.be>
    Date:   Sun Apr 22 15:18:09 2012 +0200

        darwin: first unlock drawable, only then destroy

    diff --git a/src/glx/apple/apple_glx_surface.c b/src/glx/apple/apple_glx_surface.c
    index 39f5130..1c52f86 100644
    --- a/src/glx/apple/apple_glx_surface.c
    +++ b/src/glx/apple/apple_glx_surface.c
    @@ -216,8 +216,7 @@ apple_glx_surface_destroy(unsigned int uid)
            * to actually destroy it when the pending_destroy is processed
            * by a glViewport callback (see apple_glx_context_update()).
            */
    -      d->destroy(d);
    -
           d->unlock(d);
    +      d->destroy(d);
        }
     }

After these two patches, the original wine opengl test works fine with GuardMalloc.



---

*jeremyhu@…* commented *[on Apr 22, 2012](https://xquartz.macosforge.org/trac/ticket/512#comment:35 "April 22, 2012 at 11:58 PM PDT")*

The first patch has been committed to both mesa (7.11, 8.0, and master) and is in my queue into xserver as well (since it's used for AIGLX there as well).

The second patch is also a bit more convoluted. I need to look into that code to figure out what was going on exactly. What test did you run with GuardMalloc to trigger it? If you have a reduced test case, please provide it, since you mentioned that the attached two tests actually have bugs themselves.



---

*jeremyhu@…* commented *[on Apr 23, 2012](https://xquartz.macosforge.org/trac/ticket/512#comment:36 "April 23, 2012 at 12:09 AM PDT")*

Here's the code you're affecting with the second one:

    /*
     * All surfaces are reference counted, and surfaces are only created
     * when the window is made current.  When all contexts no longer reference
     * a surface drawable the apple_glx_drawable gets destroyed, and thus
     * its surface is destroyed.
     *
     * However we can make the destruction occur a bit sooner by setting
     * pending_destroy, which is then checked for in glViewport by
     * apple_glx_context_update.
     */
    void
    apple_glx_surface_destroy(unsigned int uid)
    {
       struct apple_glx_drawable *d;

       d = apple_glx_drawable_find_by_uid(uid, APPLE_GLX_DRAWABLE_REFERENCE
                                          | APPLE_GLX_DRAWABLE_LOCK);

       if (d) {
          d->types.surface.pending_destroy = true;
          d->release(d);
          /*
           * We release 2 references to the surface.  One was acquired by
           * the find, and the other was leftover from a context, or
           * the surface being displayed, so the destroy() will decrease it
           * once more.
           *
           * If the surface is in a context, it will take one d->destroy(d);
           * to actually destroy it when the pending_destroy is processed
           * by a glViewport callback (see apple_glx_context_update()).
           */
          d->destroy(d);

          d->unlock(d);
       }

Ok, so the lock/unlock just lock and unlock the mutex on the struct itself. Fine.

release and destroy are well... bad names. release just lowers the reference count, and destroy() will free d, so there should be no dereference afterwards.

I'm curious why the d-&gt;unlock() is even there... why would the lock even be held? I don't see where it was acquired.

Also, since d-&gt;destroy() actually frees d, I don't see it actually destroying that mutex, so it looks like we leak the mutex...

God this code is ugly...



---

*jeremyhu@…* commented *[on Apr 23, 2012](https://xquartz.macosforge.org/trac/ticket/512#comment:37 "April 23, 2012 at 12:26 AM PDT")*

Ok, so great API design here... apple\_glx\_drawable\_create returns a locked object, but apple\_glx\_surface\_create doesn't.

I'm puzzled here because d-&gt;destroy (aka destroy\_drawable\_callback)'s first action is d-&gt;lock(), so it seems to expect that the provided drawable isn't locked... Also, this is consistent with d-&gt;release() which releases the lock as its last action.

    static void
    release_drawable(struct apple_glx_drawable *d)
    {
       d->lock(d);
       d->reference_count--;
       d->unlock(d);
    }

    static void
    drawable_unlock(struct apple_glx_drawable *d)
    {
       int err;

       err = pthread_mutex_unlock(&d->mutex);

       if (err) {
          fprintf(stderr, "pthread_mutex_unlock error: %d\n", err);
          abort();
       }
    }

Based on that, I'm confused why your patch doesn't abort() in drawable\_unlock. I would expect that the pthread\_mutex\_unlock would EPERM due to not actually holding the lock.

Tracing through the code, it looks like the correct fix is to just remove the d-&gt;unlock():

    commit 4557bf0b7cca7521bf13fb19f0b58a529610da27
    Author: Jeremy Huddleston <jeremyhu@apple.com>
    Date:   Mon Apr 23 00:11:50 2012 -0700

        apple: Fix a use after free
        
        Signed-off-by: Jeremy Huddleston <jeremyhu@apple.com>

    diff --git a/src/glx/apple/apple_glx_surface.c b/src/glx/apple/apple_glx_surface.c
    index 39f5130..1328284 100644
    --- a/src/glx/apple/apple_glx_surface.c
    +++ b/src/glx/apple/apple_glx_surface.c
    @@ -217,7 +217,5 @@ apple_glx_surface_destroy(unsigned int uid)
            * by a glViewport callback (see apple_glx_context_update()).
            */
           d->destroy(d);
    -
    -      d->unlock(d);
        }
     }


---

*jeremyhu@…* commented *[on Apr 23, 2012](https://xquartz.macosforge.org/trac/ticket/512#comment:38 "April 23, 2012 at 12:32 AM PDT")*

That code is old and predates re-integration with mesa: r276

So yeah, my guess it that the above should fix the crash, and I'll come up with another fix for the mutex leak ... but I'm really curious if your patch actually works for you, since as I understand it, it really shouldn't...



---

*jonas.maebe@…* commented *[on Apr 23, 2012](https://xquartz.macosforge.org/trac/ticket/512#comment:39 "April 23, 2012 at 1:14 AM PDT")*

Replying to [jeremyhu@…](https://xquartz.macosforge.org/trac/ticket/512#comment:38):

> That code is old and predates re-integration with mesa: r276
>
> So yeah, my guess it that the above should fix the crash, and I'll come up with another fix for the mutex leak ... but I'm really curious if your patch actually works for you, since as I understand it, it really shouldn't...

You've been quite busy while I was asleep :) Thanks for committing the first patch!

And it's indeed strange that the abort() isn't triggered if the mutex in fact is not locked at that point. Here's the end of the output of the gdb run from wine with both of my patches applied:

    err:wgl:X11DRV_wglCreateContext Cannot get FB Config for iPixelFormat 0, expect problems!
    fixme:dib:dibdrv_DescribePixelFormat Not supported on DIB section
    opengl.c:568: Tests skipped: Unable to find a suitable pixel format
    err:wgl:internal_SetPixelFormat Invalid operation on root_window
    err:wgl:X11DRV_wglShareLists Could not share display lists, one of the contexts has been current already !
    err:wgl:X11DRV_wglShareLists Could not share display lists because hglrc2 has already shared lists before
    opengl.c:431: Tests skipped: No suitable pixel formats found
    opengl.c:1365: Tests skipped: WGL_ARB_pbuffer not supported, skipping pbuffer test

    Program exited normally.

I can look at it in more detail tonight (CET).

Regarding which test I used: I did use wine, directly executing the opengl test using

    gdb -x opengl.gdbcomm /Data/dev/wine/winegit/loader/wine

with opengl.gdbcomm containing the following

    set env INEDLLOVERRIDES ';opengl32.dll=b'
    set env WINETEST_PLATFORM wine
    set env WINETEST_DEBUG 0
    set env DYLD_LIBRARY_PATH /Data/dev/wine/winegit/libs/wine
    set env DYLD_INSERT_LIBRARIES /usr/lib/libgmalloc.dylib
    handle SIGUSR1 pass nostop noprint
    run opengl32_test.exe.so opengl.c

(substitute /Data/dev/wine/winegit with your wine git repository location). It does take quite a while to get to the crashing point(s) with wine.



---

*jonas.maebe@…* commented *[on Apr 23, 2012](https://xquartz.macosforge.org/trac/ticket/512#comment:40 "April 23, 2012 at 2:35 AM PDT")*

Replying to [jonas.maebe@…](https://xquartz.macosforge.org/trac/ticket/512#comment:39):

> It does take quite a while to get to the crashing point(s) with wine.

Small addendum: that's of course because of the libgmalloc activation in my gdb commands script. Without libgmalloc, things are Pretty Snappy™.



---

*jonas.maebe@…* commented *[on Apr 23, 2012](https://xquartz.macosforge.org/trac/ticket/512#comment:41 "April 23, 2012 at 11:47 AM PDT")*

The mutex apparently also gets locked twice (it's a recursive mutex -&gt; can unlock as many times as you lock it):

    Breakpoint 2, drawable_lock (agd=0x422d4000) at apple_glx_drawable.c:95
    95     err = pthread_mutex_lock(&agd->mutex);
    #⁠0  drawable_lock (agd=0x422d4000) at apple_glx_drawable.c:95
    #⁠1  0x4014d801 in apple_glx_drawable_find_by_uid (uid=229, flags=6) at apple_glx_drawable.c:530
    #⁠2  0x4014f0a7 in apple_glx_surface_destroy (uid=229) at apple_glx_surface.c:203
    #⁠3  0x4014b8d3 in surface_notify_handler (dpy=0x4280ac00, uid=229, kind=1) at apple_glx.c:80
    #⁠4  0x40151a46 in wire_to_event (dpy=0x4280ac00, re=0x41d2c2b4, event=0x4196b390) at appledri.c:106
    #⁠5  0x409555c0 in _XEnq ()
    #⁠6  0x4095368e in handle_response ()
    #⁠7  0x40953d59 in _XReply ()
    #⁠8  0x40950586 in XSync ()
    #⁠9  0x4014d160 in apple_glx_garbage_collect_drawables (dpy=0x4280ac00) at apple_glx_drawable.c:365
    #⁠10 0x4014c0d2 in apple_glx_destroy_context (ptr=0x41d3464c, dpy=0x4280ac00) at apple_glx_context.c:276
    #⁠11 0x4015e009 in applegl_destroy_context (gc=0x41d345c0) at applegl_glx.c:48
    #⁠12 0x401548ab in glXDestroyContext (dpy=0x4280ac00, ctx=0x41d345c0) at glxcmds.c:424
    #⁠13 0x434c79c5 in X11DRV_wglDeleteContext (hglrc=0x1371c0) at opengl.c:1825
    #⁠14 0x41f83538 in wglDeleteContext (hglrc=0x1371c0) at opengl.c:148
    #⁠15 0x4318277a in wglDeleteContext (hglrc=0x4280ac00) at wgl.c:117
    #⁠16 0x418eb680 in test_destroy_read (oldhdc=0x1dc) at opengl.c:1245
    #⁠17 0x418ec1e6 in func_opengl () at opengl.c:1357
    #⁠18 0x418ecaae in run_test (name=0x1103f1 "opengl.c") at test.h:556
    #⁠19 0x418ecd15 in main (argc=2, argv=0x1103d0) at test.h:624
    #⁠20 0x418ed818 in __wine_spec_exe_entry () at exe_entry.c:36
    #⁠21 0x7b84f1ac in call_process_entry () at process.c:3315
    #⁠22 0x7b852207 in start_process (peb=0x7ffdf000) at process.c:1083
    #⁠23 0x7bc6769c in call_thread_func_wrapper () at signal_i386.c:556
    #⁠24 0x7bc687ba in call_thread_func (entry=Could not find the frame base for "call_thread_func".
    ) at signal_i386.c:2522
    #⁠25 0x7bc67662 in call_thread_entry_point () at signal_i386.c:556
    #⁠26 0x7bc40c8e in start_process (kernel_start=Could not find the frame base for "start_process".
    ) at loader.c:2653

    Breakpoint 2, drawable_lock (agd=0x422d4000) at apple_glx_drawable.c:95
    95     err = pthread_mutex_lock(&agd->mutex);
    #⁠0  drawable_lock (agd=0x422d4000) at apple_glx_drawable.c:95
    #⁠1  0x4014d98d in release_drawable (d=0x422d4000) at apple_glx_drawable.c:128
    #⁠2  0x4014f0cf in apple_glx_surface_destroy (uid=229) at apple_glx_surface.c:208
    #⁠3  0x4014b8d3 in surface_notify_handler (dpy=0x4280ac00, uid=229, kind=1) at apple_glx.c:80
    #⁠4  0x40151a46 in wire_to_event (dpy=0x4280ac00, re=0x41d2c2b4, event=0x4196b390) at appledri.c:106
    #⁠5  0x409555c0 in _XEnq ()
    #⁠6  0x4095368e in handle_response ()
    #⁠7  0x40953d59 in _XReply ()
    #⁠8  0x40950586 in XSync ()
    #⁠9  0x4014d160 in apple_glx_garbage_collect_drawables (dpy=0x4280ac00) at apple_glx_drawable.c:365
    #⁠10 0x4014c0d2 in apple_glx_destroy_context (ptr=0x41d3464c, dpy=0x4280ac00) at apple_glx_context.c:276
    #⁠11 0x4015e009 in applegl_destroy_context (gc=0x41d345c0) at applegl_glx.c:48
    #⁠12 0x401548ab in glXDestroyContext (dpy=0x4280ac00, ctx=0x41d345c0) at glxcmds.c:424
    #⁠13 0x434c79c5 in X11DRV_wglDeleteContext (hglrc=0x1371c0) at opengl.c:1825
    #⁠14 0x41f83538 in wglDeleteContext (hglrc=0x1371c0) at opengl.c:148
    #⁠15 0x4318277a in wglDeleteContext (hglrc=0x4280ac00) at wgl.c:117
    #⁠16 0x418eb680 in test_destroy_read (oldhdc=0x1dc) at opengl.c:1245
    #⁠17 0x418ec1e6 in func_opengl () at opengl.c:1357
    #⁠18 0x418ecaae in run_test (name=0x1103f1 "opengl.c") at test.h:556
    #⁠19 0x418ecd15 in main (argc=2, argv=0x1103d0) at test.h:624
    #⁠20 0x418ed818 in __wine_spec_exe_entry () at exe_entry.c:36
    #⁠21 0x7b84f1ac in call_process_entry () at process.c:3315
    #⁠22 0x7b852207 in start_process (peb=0x7ffdf000) at process.c:1083
    #⁠23 0x7bc6769c in call_thread_func_wrapper () at signal_i386.c:556
    #⁠24 0x7bc687ba in call_thread_func (entry=Could not find the frame base for "call_thread_func".
    ) at signal_i386.c:2522
    #⁠25 0x7bc67662 in call_thread_entry_point () at signal_i386.c:556
    #⁠26 0x7bc40c8e in start_process (kernel_start=Could not find the frame base for "start_process".
    ) at loader.c:2653

    Breakpoint 1, drawable_unlock (d=0x422d4000) at apple_glx_drawable.c:108
    108    err = pthread_mutex_unlock(&d->mutex);
    #⁠0  drawable_unlock (d=0x422d4000) at apple_glx_drawable.c:108
    #⁠1  0x4014d9ad in release_drawable (d=0x422d4000) at apple_glx_drawable.c:130
    #⁠2  0x4014f0cf in apple_glx_surface_destroy (uid=229) at apple_glx_surface.c:208
    #⁠3  0x4014b8d3 in surface_notify_handler (dpy=0x4280ac00, uid=229, kind=1) at apple_glx.c:80
    #⁠4  0x40151a46 in wire_to_event (dpy=0x4280ac00, re=0x41d2c2b4, event=0x4196b390) at appledri.c:106
    #⁠5  0x409555c0 in _XEnq ()
    #⁠6  0x4095368e in handle_response ()
    #⁠7  0x40953d59 in _XReply ()
    #⁠8  0x40950586 in XSync ()
    #⁠9  0x4014d160 in apple_glx_garbage_collect_drawables (dpy=0x4280ac00) at apple_glx_drawable.c:365
    #⁠10 0x4014c0d2 in apple_glx_destroy_context (ptr=0x41d3464c, dpy=0x4280ac00) at apple_glx_context.c:276
    #⁠11 0x4015e009 in applegl_destroy_context (gc=0x41d345c0) at applegl_glx.c:48
    #⁠12 0x401548ab in glXDestroyContext (dpy=0x4280ac00, ctx=0x41d345c0) at glxcmds.c:424
    #⁠13 0x434c79c5 in X11DRV_wglDeleteContext (hglrc=0x1371c0) at opengl.c:1825
    #⁠14 0x41f83538 in wglDeleteContext (hglrc=0x1371c0) at opengl.c:148
    #⁠15 0x4318277a in wglDeleteContext (hglrc=0x4280ac00) at wgl.c:117
    #⁠16 0x418eb680 in test_destroy_read (oldhdc=0x1dc) at opengl.c:1245
    #⁠17 0x418ec1e6 in func_opengl () at opengl.c:1357
    #⁠18 0x418ecaae in run_test (name=0x1103f1 "opengl.c") at test.h:556
    #⁠19 0x418ecd15 in main (argc=2, argv=0x1103d0) at test.h:624
    #⁠20 0x418ed818 in __wine_spec_exe_entry () at exe_entry.c:36
    #⁠21 0x7b84f1ac in call_process_entry () at process.c:3315
    #⁠22 0x7b852207 in start_process (peb=0x7ffdf000) at process.c:1083
    #⁠23 0x7bc6769c in call_thread_func_wrapper () at signal_i386.c:556
    #⁠24 0x7bc687ba in call_thread_func (entry=Could not find the frame base for "call_thread_func".
    ) at signal_i386.c:2522
    #⁠25 0x7bc67662 in call_thread_entry_point () at signal_i386.c:556
    #⁠26 0x7bc40c8e in start_process (kernel_start=Could not find the frame base for "start_process".
    ) at loader.c:2653

    Breakpoint 1, drawable_unlock (d=0x422d4000) at apple_glx_drawable.c:108
    108    err = pthread_mutex_unlock(&d->mutex);
    #⁠0  drawable_unlock (d=0x422d4000) at apple_glx_drawable.c:108
    #⁠1  0x4014f0e0 in apple_glx_surface_destroy (uid=229) at apple_glx_surface.c:219
    #⁠2  0x4014b8d3 in surface_notify_handler (dpy=0x4280ac00, uid=229, kind=1) at apple_glx.c:80
    #⁠3  0x40151a46 in wire_to_event (dpy=0x4280ac00, re=0x41d2c2b4, event=0x4196b390) at appledri.c:106
    #⁠4  0x409555c0 in _XEnq ()
    #⁠5  0x4095368e in handle_response ()
    #⁠6  0x40953d59 in _XReply ()
    #⁠7  0x40950586 in XSync ()
    #⁠8  0x4014d160 in apple_glx_garbage_collect_drawables (dpy=0x4280ac00) at apple_glx_drawable.c:365
    #⁠9  0x4014c0d2 in apple_glx_destroy_context (ptr=0x41d3464c, dpy=0x4280ac00) at apple_glx_context.c:276
    #⁠10 0x4015e009 in applegl_destroy_context (gc=0x41d345c0) at applegl_glx.c:48
    #⁠11 0x401548ab in glXDestroyContext (dpy=0x4280ac00, ctx=0x41d345c0) at glxcmds.c:424
    #⁠12 0x434c79c5 in X11DRV_wglDeleteContext (hglrc=0x1371c0) at opengl.c:1825
    #⁠13 0x41f83538 in wglDeleteContext (hglrc=0x1371c0) at opengl.c:148
    #⁠14 0x4318277a in wglDeleteContext (hglrc=0x4280ac00) at wgl.c:117
    #⁠15 0x418eb680 in test_destroy_read (oldhdc=0x1dc) at opengl.c:1245
    #⁠16 0x418ec1e6 in func_opengl () at opengl.c:1357
    #⁠17 0x418ecaae in run_test (name=0x1103f1 "opengl.c") at test.h:556
    #⁠18 0x418ecd15 in main (argc=2, argv=0x1103d0) at test.h:624
    #⁠19 0x418ed818 in __wine_spec_exe_entry () at exe_entry.c:36
    #⁠20 0x7b84f1ac in call_process_entry () at process.c:3315
    #⁠21 0x7b852207 in start_process (peb=0x7ffdf000) at process.c:1083
    #⁠22 0x7bc6769c in call_thread_func_wrapper () at signal_i386.c:556
    #⁠23 0x7bc687ba in call_thread_func (entry=Could not find the frame base for "call_thread_func".
    ) at signal_i386.c:2522
    #⁠24 0x7bc67662 in call_thread_entry_point () at signal_i386.c:556
    #⁠25 0x7bc40c8e in start_process (kernel_start=Could not find the frame base for "start_process".
    ) at loader.c:2653


---

*cdavis@…* commented *[on Apr 23, 2012](https://xquartz.macosforge.org/trac/ticket/512#comment:42 "April 23, 2012 at 3:17 PM PDT")*

All right, I tried your patches, and the crash is gone. Hopefully, both patches will make it into Mesa 8.0.3.

When I built Mesa from Git to test them, though, I had to turn off Gallium to make it build, because *someone* (whose name rhymes with "Dom Bellard") decided that Gallium needs to use automake.



---

*jonas.maebe@…* commented *[on Apr 23, 2012](https://xquartz.macosforge.org/trac/ticket/512#comment:43 "April 23, 2012 at 3:28 PM PDT")*

Replying to [cdavis@…](https://xquartz.macosforge.org/trac/ticket/512#comment:42):

> All right, I tried your patches, and the crash is gone.

Good!

> When I built Mesa from Git to test them, though, I had to turn off Gallium to make it build, because *someone* (whose name rhymes with "Dom Bellard") decided that Gallium needs to use automake.

See <http://lists.macosforge.org/pipermail/xquartz-dev/2012-April/003592.html> for the Mesa build instructions on Darwin.



---

*cdavis@…* commented *[on Apr 23, 2012](https://xquartz.macosforge.org/trac/ticket/512#comment:44 "April 23, 2012 at 3:53 PM PDT")*

Replying to [jonas.maebe@…](https://xquartz.macosforge.org/trac/ticket/512#comment:43):

> Replying to [cdavis@…](https://xquartz.macosforge.org/trac/ticket/512#comment:42):
>
> > When I built Mesa from Git to test them, though, I had to turn off Gallium to make it build, because *someone* (whose name rhymes with "Dom Bellard") decided that Gallium needs to use automake.
>
> See <http://lists.macosforge.org/pipermail/xquartz-dev/2012-April/003592.html> for the Mesa build instructions on Darwin.

I knew about needing to use the darwin config--I figured it out from MacPorts' Portfile--but I used the master branch, which probably explains a lot :). I suspect though that future versions of Mesa are going to dispense with the config files entirely and use automake/autoconf exclusively--which might be a problem for Darwin and its special needs.

OK, it still works after building off of the 8.0 branch. Thanks!



---

*jeremyhu@…* commented *[on Apr 23, 2012](https://xquartz.macosforge.org/trac/ticket/512#comment:45 "April 23, 2012 at 3:58 PM PDT")*

Wow, so apple\_glx\_drawable\_find\_by\_uid returns it locked. That seems really wrong to me.

So the unlock is needed. Your change is the right one. I'll add a comment in there to explain why it's the case.



---

*jeremyhu@…* commented *[on Apr 23, 2012](https://xquartz.macosforge.org/trac/ticket/512#comment:46 "April 23, 2012 at 4:45 PM PDT")*

Ok, so the unlock change is now in mesa master, 8.0, and 7.11.

This should fix the mutex leak. Please test it, so I can mark it Tested-by you in the commit log. Thanks.

    commit 17daead240a9983403c53ee9a1f03a368d9810e0
    Author: Jeremy Huddleston <jeremyhu@apple.com>
    Date:   Mon Apr 23 16:43:22 2012 -0700

        darwin: Eliminate a pthread mutex leak
        
        Signed-off-by: Jeremy Huddleston <jeremyhu@apple.com>

    diff --git a/src/glx/apple/apple_glx_drawable.c b/src/glx/apple/apple_glx_drawable.c
    index 5530224..db28302 100644
    --- a/src/glx/apple/apple_glx_drawable.c
    +++ b/src/glx/apple/apple_glx_drawable.c
    @@ -135,6 +135,7 @@ release_drawable(struct apple_glx_drawable *d)
     static bool
     destroy_drawable(struct apple_glx_drawable *d)
     {
    +   int err;
     
        d->lock(d);
     
    @@ -172,6 +173,12 @@ destroy_drawable(struct apple_glx_drawable *d)
     
        apple_glx_diagnostic("%s: freeing %p\n", __func__, (void *) d);
     
    +   err = pthread_mutex_destroy(&d->mutex);
    +   if (err) {
    +      fprintf(stderr, "pthread_mutex_destroy error: %s\n", strerror(err));
    +      abort();
    +   }
    +   
        free(d);
     
        /* So that the locks are balanced and the caller correctly unlocks. */


---

*cdavis@…* commented *[on Apr 23, 2012](https://xquartz.macosforge.org/trac/ticket/512#comment:47 "April 23, 2012 at 5:23 PM PDT")*

Replying to [jeremyhu@…](https://xquartz.macosforge.org/trac/ticket/512#comment:46):

> Ok, so the unlock change is now in mesa master, 8.0, and 7.11.
>
> This should fix the mutex leak. Please test it, so I can mark it Tested-by you in the commit log. Thanks.

It works. Thanks!



---

*jeremyhu@…* commented *[on Apr 24, 2012](https://xquartz.macosforge.org/trac/ticket/512#comment:48 "April 24, 2012 at 12:34 AM PDT")*

-   **Status** changed from *assigned* to *closed*
-   **Resolution** changed from to *fixed*

Thanks. All three patches are in mesa git and Macports' mesa port. They will also be in the next XQuartz (2.7.2\_rc1).



---

*jeremyhu@…* commented *[on Apr 24, 2012](https://xquartz.macosforge.org/trac/ticket/512#comment:49 "April 24, 2012 at 12:51 AM PDT")*

Again, I just want to reiterate ... thanks a ton for your help. I certainly wouldn't've gotten the time to sit down and debug this to find the solution for months. This was a tremendous help, and I'm sure many people will appreciate these fixes.



---

*jonas.maebe@…* commented *[on Apr 24, 2012](https://xquartz.macosforge.org/trac/ticket/512#comment:50 "April 24, 2012 at 2:28 AM PDT")*

And thank you for being a very responsive and encouraging core developer! Certain Wine developers sure could learn a thing or two from you ;) Then again, so could I from time to time when dealing with bug reports to the project I mainly work on...



